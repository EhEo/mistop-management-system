name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v3
    
    - name: ë°°í¬ ì‹¤í–‰
      run: |
        echo "ğŸš€ ë°°í¬ ì‹œì‘..."
        
        # API ì„œë²„ ì—…ë°ì´íŠ¸
        echo "ğŸ“¦ API ì„œë²„ ì—…ë°ì´íŠ¸ ì¤‘..."
        rsync -av --exclude='node_modules' --exclude='dist' --exclude='.env' \
          $GITHUB_WORKSPACE/api/ /var/www/api/
        
        # í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸
        echo "ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
        rsync -av --exclude='*.backup' \
          $GITHUB_WORKSPACE/frontend/ /var/www/auth/
        
        # API ë¹Œë“œ
        echo "ğŸ”¨ ë¹Œë“œ ì¤‘..."
        cd /var/www/api
        npm install
        npm run build
        
        # ì„œë²„ ì¬ì‹œì‘
        echo "ğŸ”„ ì„œë²„ ì¬ì‹œì‘ ì¤‘..."
        pm2 restart api
        
        echo "âœ… ë°°í¬ ì™„ë£Œ!"
