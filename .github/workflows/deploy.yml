name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: 체크아웃
      uses: actions/checkout@v3
    
    - name: 배포 실행
      run: |
        echo "🚀 배포 시작..."
        
        # API 서버 업데이트
        echo "📦 API 서버 업데이트 중..."
        rsync -av --exclude='node_modules' --exclude='dist' --exclude='.env' \
          $GITHUB_WORKSPACE/api/ /var/www/api/
        
        # 프론트엔드 업데이트
        echo "🎨 프론트엔드 업데이트 중..."
        rsync -av --exclude='*.backup' \
          $GITHUB_WORKSPACE/frontend/ /var/www/auth/
        
        # API 빌드
        echo "🔨 빌드 중..."
        cd /var/www/api
        npm install
        npm run build
        
        # 서버 재시작
        echo "🔄 서버 재시작 중..."
        pm2 restart api
        
        echo "✅ 배포 완료!"
